<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personalization Playground — Web Preview</title>
  <style>
    :root{
      --accent:#4F46E5; /* default indigo */
      --bg:#0b1020;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#0f172a;
      --chip:#EEF2FF;
      --radius:16px;
      --shadow:0 6px 18px rgba(17,24,39,0.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text); background:#F6F7FB;
    }
    a{color:inherit}
    .wrap{max-width:1200px; margin:0 auto; padding:24px}
    .topbar{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(246,247,251,0.95), rgba(246,247,251,0.6)); backdrop-filter:saturate(1.2) blur(8px); border-bottom:1px solid #e5e7eb}
    .controls{display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; align-items:end}
    .control{grid-column: span 3}
    .control.small{grid-column: span 2}
    .control.wide{grid-column: span 6}
    label{font-size:12px; color:var(--muted); letter-spacing:.02em}
    select, input[type="text"], input[type="url"], input[type="color"]{
      width:100%; padding:10px 12px; font-size:14px; border-radius:12px; border:1px solid #e5e7eb; background:white; outline:none;
    }
    button{border:0; border-radius:999px; padding:10px 14px; font-weight:600; box-shadow:var(--shadow); cursor:pointer}
    .btn-primary{background:var(--accent); color:white}
    .btn-ghost{background:white; color:#111827; border:1px solid #e5e7eb; box-shadow:none}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{background:var(--chip); border-radius:999px; padding:6px 10px; font-size:12px}

    .grid{display:grid; grid-template-columns: 1.35fr .65fr; gap:20px; margin-top:16px}

    /* Preview site */
    .site{background:white; border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .site .chrome{display:flex; align-items:center; gap:12px; padding:14px 16px; border-bottom:1px solid #eef2f7}
    .logo{width:28px; height:28px; border-radius:8px; background:var(--accent); display:grid; place-items:center; color:white; font-weight:800}
    .brand{font-weight:800}
    .pill{font-size:12px; padding:6px 10px; border-radius:999px; background:#f1f5f9; color:#0f172a; margin-left:auto}

    .hero{position:relative; overflow:hidden; padding:28px; background:linear-gradient(135deg, var(--accent), #93C5FD); color:white}
    .hero h2{margin:0 0 8px 0}
    .hero p{margin:0}
    .hero .cta{margin-top:14px}

    .site-content{padding:18px}
    .modules{display:grid; grid-template-columns: 1fr; gap:14px}
    .card{background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:14px}
    .card h3{margin:0 0 10px 0}

    .collection-row{display:flex; gap:12px; overflow:auto; padding-bottom:4px}
    .col-card{min-width:180px; height:92px; border-radius:12px; background:linear-gradient(120deg, #EEF2FF, #F5F3FF); display:flex; align-items:flex-end; padding:10px; font-weight:700}

    .product-grid{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px}
    .product{border:1px solid #eef2f7; border-radius:12px; overflow:hidden; background:white; position:relative}
    .p-thumb{height:120px; background:linear-gradient(135deg, #e5e7eb, #f3f4f6); display:grid; place-items:center; font-weight:800}
    .p-body{padding:10px}
    .price{font-weight:800}
    .muted{color:var(--muted)}
    .badge{position:absolute; top:8px; left:8px; background:var(--accent); color:white; font-size:11px; padding:4px 8px; border-radius:999px}
    .note{font-size:12px; color:var(--muted)}

    /* Side panel */
    .side{display:flex; flex-direction:column; gap:12px}
    .side .card ul{margin:0; padding-left:18px}

    .footer{margin-top:20px; display:flex; gap:8px; align-items:center}
    .accent-dot{width:10px; height:10px; border-radius:999px; background:var(--accent); border:2px solid white; box-shadow:0 0 0 2px rgba(0,0,0,0.06)}

    @media (max-width: 980px){
      .controls{grid-template-columns: repeat(6, 1fr)}
      .control{grid-column: span 6}
      .control.small{grid-column: span 3}
      .grid{grid-template-columns: 1fr}
      .product-grid{grid-template-columns: repeat(2, minmax(0,1fr))}
    }
    @media (max-width: 560px){
      .product-grid{grid-template-columns: 1fr}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px">
        <div class="logo" id="topLogo">WE</div>
        <div style="font-weight:800">Personalization Playground</div>
        <div class="pill" id="statePill">State: –</div>
        <div style="margin-left:auto; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn-ghost" id="resetBtn" title="Reset to defaults">Reset</button>
          <button class="btn-primary" id="copyLinkBtn" title="Copy link to this exact state">Copy sharable link</button>
        </div>
      </div>
      <div class="controls">
        <div class="control">
          <label>Industry</label>
          <select id="industry">
            <option>Retail</option>
            <option>FMCD</option>
            <option>D2C</option>
            <option>Healthcare</option>
          </select>
        </div>
        <div class="control">
          <label>Recommendation model</label>
          <select id="model">
            <option value="static">Static (editorial)</option>
            <option value="dynamic">Dynamic (behavioral)</option>
            <option value="collections">Collections (curated)</option>
          </select>
        </div>
        <div class="control">
          <label>Rule bias</label>
          <select id="bias">
            <option value="price">Price-focused</option>
            <option value="rating">Ratings-focused</option>
            <option value="affinity">Affinity-focused</option>
          </select>
        </div>
        <div class="control">
          <label>User context</label>
          <select id="user">
            <option value="new">New user</option>
            <option value="returning">Returning</option>
            <option value="known">Known (identified)</option>
          </select>
        </div>

        <div class="control small">
          <label>Brand name</label>
          <input id="brand" type="text" placeholder="Acme" />
        </div>
        <div class="control small">
          <label>Website URL</label>
          <input id="siteUrl" type="url" placeholder="https://example.com" />
        </div>
        <div class="control small">
          <label>Accent color</label>
          <input id="color" type="color" value="#4F46E5" />
        </div>
        <div class="control wide">
          <label>Email (for Known users)</label>
          <input id="email" type="text" placeholder="user@brand.com" />
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="site" id="site">
        <div class="chrome">
          <div class="logo" id="siteLogo">WE</div>
          <div class="brand" id="brandName">Acme</div>
          <div class="pill" id="industryPill">Retail</div>
        </div>
        <div class="hero">
          <h2 id="heroTitle">Welcome to Acme</h2>
          <p id="heroSub">Smart recommendations powered by your behavior.</p>
          <div class="cta">
            <button class="btn-primary" id="ctaBtn">Shop now</button>
          </div>
        </div>
        <div class="site-content">
          <div class="modules" id="modules"></div>
          <p class="note">This is a simulator for demo purposes only. Product data is synthetic.
          </p>
        </div>
      </div>

      <div class="side">
        <div class="card">
          <h3>What changed & why</h3>
          <ul id="whyList"></ul>
        </div>
        <div class="card">
          <h3>Common plays by industry</h3>
          <div id="plays" class="chips"></div>
        </div>
        <div class="card">
          <h3>Compliance & governance</h3>
          <ul>
            <li>Consent-first capture for identifiers; clear opt-in.</li>
            <li>Consent and preferences logged with timestamp.</li>
            <li>PII handled via secure APIs; masked in at-rest logs.</li>
            <li>Deterministic & probabilistic ID graphs with safe fallbacks.</li>
          </ul>
        </div>
        <div class="card">
          <h3>Diagnostics</h3>
          <button class="btn-ghost" id="runTestsBtn">Run self‑tests</button>
          <ul id="testResults" class="muted"></ul>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="accent-dot"></div>
      <div class="muted">Tip: Use the controls above, or pass query params like <code>?industry=retail&model=dynamic&bias=affinity&user=returning&brand=Acme&color=%23007AFF</code></div>
    </div>
  </div>

  <script>
    // ---- Utilities (safe selectors & small helpers) ----------------------
    const elCache = new Map();
    function el(id){
      if (!elCache.has(id)){
        elCache.set(id, document.getElementById(id));
      }
      return elCache.get(id);
    }
    function req(id){
      const n = el(id);
      if(!n) throw new Error(`Missing element #${id}`);
      return n;
    }
    function initials(str){
      const parts = (str||'A C').split(/\s+/).slice(0,2);
      return parts.map(s=>s[0]||'').join('').toUpperCase();
    }
    function pick(val, def, allowed){
      if (!val) return def;
      const norm = String(val).trim();
      const hit = allowed.find(a=> a.toLowerCase()===norm.toLowerCase());
      return hit || def;
    }
    function validateColor(c){
      return /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(c);
    }
    function stars(r){
      const full = Math.floor(r); const half = r - full >= 0.5;
      let s='';
      for(let i=0;i<full;i++) s += '★';
      if (half) s+='☆';
      return s;
    }

    // ---- Data ------------------------------------------------------------
    function p(name, price, rating, tags, code){
      return {id: name.toLowerCase().replace(/[^a-z0-9]+/g,'-'), name, price, rating, tags, code}
    }
    const CATALOG = {
      Retail: [
        p("Nova Sneakers", 79, 4.7, ["shoes","athleisure","men"], "NS"),
        p("Luna Tote", 64, 4.4, ["bags","women"], "LT"),
        p("Aero Tee", 24, 4.2, ["apparel","unisex"], "AT"),
        p("Quartz Watch", 149, 4.8, ["accessory","unisex","premium"], "QW"),
        p("Denim Jacket", 92, 4.5, ["apparel","men"], "DJ"),
        p("Silk Scarf", 38, 4.3, ["accessory","women"], "SS"),
        p("Trail Backpack", 88, 4.6, ["bags","unisex","outdoor"], "TB"),
        p("Comfy Socks (3)", 12, 4.1, ["accessory","value"], "CS")
      ],
      FMCD: [
        p("FrostX 300L Fridge", 399, 4.5, ["appliance","kitchen","value"], "FR"),
        p("BreezeMax 1.5T AC", 529, 4.6, ["cooling","premium"], "AC"),
        p("AquaPure RO", 189, 4.3, ["water","kitchen"], "RO"),
        p("SwiftWash 7kg", 329, 4.4, ["laundry","value"], "WM"),
        p("ChefPro Induction", 69, 4.2, ["kitchen","value"], "IH"),
        p("TurboVac Max", 149, 4.1, ["home","cleaning"], "VC"),
        p("GlowHeat Geyser", 119, 4.0, ["bath","water"], "GY"),
        p("SteelCool Fan", 59, 4.3, ["cooling","value"], "FN" )
      ],
      D2C: [
        p("Plant Protein (1kg)", 24, 4.5, ["nutrition","value"], "PP"),
        p("Glow Serum 30ml", 18, 4.7, ["beauty","premium"], "GS"),
        p("Bamboo Toothbrush (2)", 6, 4.2, ["home","eco"], "BT"),
        p("Daily Multivitamin", 12, 4.3, ["nutrition"], "MV"),
        p("Cold Brew Bottles (6)", 14, 4.4, ["beverage","trending"], "CB"),
        p("Ceramic Mug", 8, 4.1, ["home","value"], "MG"),
        p("Yoga Strap", 10, 4.0, ["fitness","eco"], "YS"),
        p("No-Sugar Granola", 9, 4.2, ["food","healthy"], "GR" )
      ],
      Healthcare: [
        p("Digital Thermometer", 9, 4.5, ["device","value"], "DT"),
        p("BP Monitor", 34, 4.6, ["device","homecare"], "BP"),
        p("Orthopedic Pillow", 19, 4.3, ["sleep","comfort"], "OP"),
        p("Nebulizer Compact", 29, 4.4, ["device","respiratory"], "NB"),
        p("Multivitamin 60 tabs", 11, 4.2, ["supplement","value"], "SV"),
        p("Sugar Check Strips (50)", 13, 4.1, ["device","diabetes"], "SC"),
        p("Cold & Flu Care Pack", 7, 4.0, ["otc","seasonal"], "CF"),
        p("Hand Sanitizer 500ml", 4, 4.0, ["otc","value"], "HS" )
      ]
    };
    const COLLECTIONS = {
      Retail:["Festive Picks","Office Essentials","Weekend Fits"],
      FMCD:["Summer Cooling","Kitchen Staples","Home Hygiene"],
      D2C:["Wellness Starter","Eco Basics","Trending Now"],
      Healthcare:["Home Care Essentials","Respiratory Care","Daily Wellness"]
    }
    const INDUSTRY_PLAYS = {
      Retail:["Exit-intent email capture for unknown users","Recently viewed + similar items","Price drop alerts for wishlist"],
      FMCD:["AMC / warranty nudge post-purchase","Service due reminders (RCS/WA)","Location-aware store demo booking"],
      D2C:["Bundles based on affinity","Subscription trial upsell","UGC-driven top-rated row"],
      Healthcare:["Condition-based guidance (non-diagnostic)","Reorder reminders","Tele-consult booking CTA"]
    }

    // ---- App state -------------------------------------------------------
    const qs = new URLSearchParams(location.search);
    const state = {
      industry: pick(qs.get('industry'), 'Retail', ['Retail','FMCD','D2C','Healthcare']),
      model: pick(qs.get('model'), 'dynamic', ['static','dynamic','collections']),
      bias: pick(qs.get('bias'), 'affinity', ['price','rating','affinity']),
      user: pick(qs.get('user'), 'new', ['new','returning','known']),
      brand: qs.get('brand') || 'Acme',
      site: qs.get('site') || '',
      color: qs.get('color') || '#4F46E5',
      email: qs.get('email') || ''
    };

    // ---- Boot after DOM is ready ----------------------------------------
    document.addEventListener('DOMContentLoaded', boot);

    function boot(){
      // Inputs map (avoid duplicate IDs — website input is #siteUrl; preview container is #site)
      const inputs = {
        industry: req('industry'),
        model: req('model'),
        bias: req('bias'),
        user: req('user'),
        brand: req('brand'),
        siteUrl: req('siteUrl'),
        color: req('color'),
        email: req('email')
      };

      // Seed values
      inputs.industry.value = state.industry;
      inputs.model.value = state.model;
      inputs.bias.value = state.bias;
      inputs.user.value = state.user;
      inputs.brand.value = state.brand;
      inputs.siteUrl.value = state.site;
      inputs.color.value = state.color;
      inputs.email.value = state.email;

      // Input listeners
      Object.entries(inputs).forEach(([key, inp])=>{
        inp.addEventListener('change', ()=>{
          const map = {siteUrl:'site'};
          state[map[key] || key] = inp.value;
          render();
          syncUrl();
        })
      });

      // Topbar buttons
      req('resetBtn').onclick = reset;
      req('copyLinkBtn').onclick = copyLink;
      req('runTestsBtn').onclick = runTests;

      // First paint
      render();
      syncUrl();

      // Auto-run tests when ?test=1
      if (qs.get('test') === '1') runTests();
    }

    // ---- Core render -----------------------------------------------------
    function render(){
      // theme
      document.documentElement.style.setProperty('--accent', validateColor(state.color) ? state.color : '#4F46E5');
      req('topLogo').textContent = initials(state.brand || 'Acme');

      // chrome
      const siteLogo = req('siteLogo');
      siteLogo.textContent = initials(state.brand || 'Acme');
      siteLogo.style.background = 'var(--accent)';
      req('brandName').textContent = state.brand || 'Acme';
      req('industryPill').textContent = state.industry;

      // hero text per state
      const heroTitle = {
        new: `Welcome to ${state.brand || 'our store'}`,
        returning: `Welcome back ${state.brand ? 'to '+state.brand : ''}`,
        known: `Hi ${state.email || 'there'} — great to see you again`
      }[state.user];
      req('heroTitle').textContent = heroTitle;
      req('heroSub').textContent = subCopy();

      req('statePill').textContent = `State: ${state.industry} • ${state.model} • ${state.bias} • ${state.user}`;

      // modules
      const modules = req('modules');
      modules.innerHTML = '';

      // 1) Collections row (for collections model) or Trending (others)
      const colCard = sectionCard(state.model === 'collections' ? 'Featured Collections' : 'Trending Now');
      const colRow = document.createElement('div'); colRow.className = 'collection-row';
      const cols = state.model === 'collections' ? COLLECTIONS[state.industry] : COLLECTIONS[state.industry].slice(0,2);
      cols.forEach(cn => {
        const cc = document.createElement('div'); cc.className = 'col-card'; cc.textContent = cn; colRow.appendChild(cc);
      })
      colCard.appendChild(colRow);
      modules.appendChild(colCard);

      // 2) Recommended grid
      const recCard = sectionCard(recoTitle());
      const grid = document.createElement('div'); grid.className = 'product-grid';
      productsForState().forEach((prod, i) => {
        grid.appendChild(productCard(prod, i));
      })
      recCard.appendChild(grid);
      modules.appendChild(recCard);

      // 3) Contextual modules
      if (state.user === 'returning'){
        modules.appendChild(infoCard('Recently viewed', 'Based on your last visit, we saved these for you.'))
      }
      // Loyalty card for all industries when Known (per your clarification)
      if (state.user === 'new'){
        modules.appendChild(captureCard());
      }
      if (state.user === 'known'){
        modules.appendChild(loyaltyCard());
      }

      // side panel explains
      renderWhy();
      renderPlays();
    }

    function sectionCard(title){
      const card = document.createElement('div'); card.className='card';
      const h = document.createElement('h3'); h.textContent = title; card.appendChild(h);
      return card;
    }
    function infoCard(title, sub){
      const c = sectionCard(title);
      const p = document.createElement('p'); p.className='muted'; p.textContent = sub; c.appendChild(p);
      return c;
    }
    function captureCard(){
      const c = sectionCard('Get more relevant picks');
      const p = document.createElement('p'); p.textContent = 'Tell us where to send your order updates.'; c.appendChild(p);
      const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px';
      const inp = document.createElement('input'); inp.placeholder='you@email.com'; inp.style.flex='1'; inp.style.padding='10px 12px'; inp.style.border='1px solid #e5e7eb'; inp.style.borderRadius='10px';
      const btn = document.createElement('button'); btn.className='btn-primary'; btn.textContent='Continue';
      btn.onclick = ()=>{ state.user='known'; state.email = inp.value || 'user@demo.com'; req('user').value='known'; req('email').value=state.email; render(); syncUrl(); toast('Identified as Known'); }
      row.appendChild(inp); row.appendChild(btn); c.appendChild(row);
      return c;
    }
    function loyaltyCard(){
      const c = sectionCard('Loyalty boost');
      const p = document.createElement('p'); p.innerHTML = `Welcome <b>${state.email||'member'}</b>. Earn <b>2× points</b> on ${state.industry==='FMCD'?'AMC add-ons':'today\'s picks'} when you checkout in the next <b>24h</b>.`;
      c.appendChild(p);
      const btn = document.createElement('button'); btn.className='btn-primary'; btn.textContent='Activate offer'; c.appendChild(btn);
      return c;
    }

    function productCard(prod, i){
      const card = document.createElement('div'); card.className='product';
      const badge = document.createElement('div'); badge.className='badge'; badge.textContent = badgeText(prod, i); card.appendChild(badge);
      const th = document.createElement('div'); th.className='p-thumb'; th.textContent = prod.code; card.appendChild(th);
      const body = document.createElement('div'); body.className='p-body';
      const name = document.createElement('div'); name.style.fontWeight='700'; name.textContent = prod.name; body.appendChild(name);
      const meta = document.createElement('div'); meta.className='muted'; meta.innerHTML = `${stars(prod.rating)} • $${prod.price}`; body.appendChild(meta);
      card.appendChild(body);
      return card;
    }

    function recoTitle(){
      if (state.model==='static') return 'Editor\'s picks';
      if (state.model==='collections') return 'From this collection';
      return 'Recommended for you';
    }

    function badgeText(prod, i){
      switch(state.bias){
        case 'price': return i===0? 'Best Value' : (prod.price<=medianPrice()? 'Value' : '');
        case 'rating': return prod.rating>=4.6? 'Top Rated' : '';
        case 'affinity': return (prod.tags||[]).some(t=> affinityTags().includes(t))? 'High Affinity' : '';
      }
      return '';
    }

    function medianPrice(){
      const arr = CATALOG[state.industry].map(p=>p.price).sort((a,b)=>a-b);
      const mid = Math.floor(arr.length/2);
      return arr.length%2? arr[mid] : (arr[mid-1]+arr[mid])/2;
    }

    function subCopy(){
      if (state.model==='static') return 'Curated by our merch team for this season.';
      if (state.model==='collections') return 'Explore themed sets tailored to your industry.';
      if (state.bias==='price') return 'Sorted by better value for money.';
      if (state.bias==='rating') return 'Surfacing the top-rated items first.';
      return 'Learning from your browsing to boost relevance.';
    }

    function affinityTags(){
      const base = {
        Retail:["athleisure","accessory","premium"],
        FMCD:["cooling","kitchen","appliance"],
        D2C:["beauty","nutrition","eco"],
        Healthcare:["device","homecare","otc"]
      }[state.industry] || [];
      if (state.user==='returning') base.push('trending');
      if (state.user==='known') base.push('premium');
      return base;
    }

    function score(prod){
      const bias = state.bias;
      if (bias==='price') return -prod.price + prod.rating*2; // cheaper first (tie-break by rating)
      if (bias==='rating') return prod.rating*10 - prod.price*0.05;
      if (bias==='affinity'){
        const hit = (prod.tags||[]).reduce((acc,t)=> acc + (affinityTags().includes(t)?1:0), 0);
        return hit*10 + prod.rating*2 - prod.price*0.02;
      }
      return prod.rating;
    }

    function productsForState(){
      const src = CATALOG[state.industry].slice();
      if (state.model==='static'){
        return src.slice(0,6); // editorial order
      }
      const sorted = src.sort((a,b)=> score(b)-score(a));
      return sorted.slice(0,6);
    }

    function renderWhy(){
      const ul = req('whyList');
      ul.innerHTML='';
      const bullets = [];
      if (state.model==='collections') bullets.push('Showing curated collections for faster discovery.');
      if (state.model==='dynamic') bullets.push('Grid reordered dynamically based on rules & behavior.');
      if (state.model==='static') bullets.push('Editorial list, unchanged by user behavior.');

      if (state.bias==='price') bullets.push('Optimized for value: lower prices surface first.');
      if (state.bias==='rating') bullets.push('Optimized for trust: top-rated items surface first.');
      if (state.bias==='affinity') bullets.push('Optimized for affinity: tags matching user/industry boosted.');

      if (state.user==='new') bullets.push('New user: broader trending + gentle ID capture.');
      if (state.user==='returning') bullets.push('Returning: recently-viewed and lookalikes prioritized.');
      if (state.user==='known') bullets.push(`Known: personalized copy & loyalty nudge for ${state.email||'member'}.`);

      bullets.forEach(b=>{ const li = document.createElement('li'); li.textContent=b; ul.appendChild(li); })
    }

    function renderPlays(){
      const host = req('plays');
      host.innerHTML='';
      (INDUSTRY_PLAYS[state.industry]||[]).forEach(t=>{
        const c = document.createElement('div'); c.className='chip'; c.textContent=t; host.appendChild(c);
      })
    }

    // ---- URL & UX helpers ------------------------------------------------
    function reset(){
      Object.assign(state, {industry:'Retail', model:'dynamic', bias:'affinity', user:'new', brand:'Acme', site:'', color:'#4F46E5', email:''});
      // re-seed inputs
      req('industry').value = state.industry;
      req('model').value = state.model;
      req('bias').value = state.bias;
      req('user').value = state.user;
      req('brand').value = state.brand;
      req('siteUrl').value = state.site;
      req('color').value = state.color;
      req('email').value = state.email;
      render(); syncUrl();
    }

    function syncUrl(){
      const params = new URLSearchParams();
      for (const [k,v] of Object.entries(state)){
        if (String(v||'').length) params.set(k, v);
      }
      const url = location.pathname + '?' + params.toString();
      history.replaceState(null, '', url);
    }

    async function copyLink(){
      try{
        await navigator.clipboard.writeText(location.href);
        toast('Link copied');
      }catch(e){ alert('Link: '+location.href); }
    }

    function toast(msg){
      const n = document.createElement('div');
      n.textContent = msg;
      n.style.cssText = 'position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:var(--accent); color:#fff; padding:10px 14px; border-radius:999px; box-shadow:var(--shadow); z-index:50;'
      document.body.appendChild(n);
      setTimeout(()=> n.remove(), 1500);
    }

    // ---- Self-tests (basic smoke) ---------------------------------------
    function runTests(){
      const out = req('testResults');
      out.innerHTML = '';
      const results = [];
      function assert(name, fn){
        try{ fn(); results.push(['pass', name]); }
        catch(e){ results.push(['fail', name+` → ${e.message}`]); }
      }

      // T1: Critical elements exist
      assert('Elements present', ()=>{
        ['topLogo','siteLogo','brandName','industryPill','heroTitle','heroSub','modules','whyList','plays'].forEach(id=> req(id));
      });

      // T2: Render does not throw for all state combos
      assert('Render across combos', ()=>{
        const industries = ['Retail','FMCD','D2C','Healthcare'];
        const models = ['static','dynamic','collections'];
        const biases = ['price','rating','affinity'];
        const users = ['new','returning','known'];
        for (const a of industries){ for (const b of models){ for (const c of biases){ for (const d of users){
          Object.assign(state, {industry:a, model:b, bias:c, user:d});
          render();
        }}}}
      });

      // T3: Brand initials update in both top logo and site logo
      assert('Brand initials reflect brand name', ()=>{
        const old = state.brand; state.brand = 'Blue River'; render();
        if (req('topLogo').textContent !== 'BR') throw new Error('Top initials not updated');
        if (req('siteLogo').textContent !== 'BR') throw new Error('Site initials not updated');
        state.brand = old; render();
      });

      // T4: Known user greeting uses email when provided
      assert('Known user uses email', ()=>{
        Object.assign(state, {user:'known', email:'vip@example.com'}); render();
        if (!req('heroTitle').textContent.includes('vip@example.com')) throw new Error('Email not reflected in hero');
      });

      // T5: Loyalty card appears for all industries when Known
      assert('Loyalty card for all industries (Known)', ()=>{
        const industries = ['Retail','FMCD','D2C','Healthcare'];
        for (const ind of industries){
          Object.assign(state, {industry: ind, user:'known', email:'test@example.com'}); render();
          if (!req('modules').innerText.includes('Loyalty boost')) throw new Error(`Missing loyalty card for ${ind}`);
        }
      });

      // Print results
      results.forEach(([status,msg])=>{
        const li = document.createElement('li'); li.textContent = `${status.toUpperCase()} — ${msg}`; li.style.color = status==='pass'? '#065f46':'#B91C1C'; out.appendChild(li);
      });
      toast(`${results.filter(r=>r[0]==='pass').length}/${results.length} tests passed`);
      console.log('Self-test results:', results);
    }
  </script>
</body>
</html>
